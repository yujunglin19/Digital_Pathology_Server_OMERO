# OMERO Docker Compose SOP

## Docker compose
  
  The basic docker compose YAML file for OMERO consists of three parts on the highest level: `networks`, `volumes`, and `services`.

  - networks

      In order for the containers to be recognizable and reachable by other containers, `networks` is required. when compose is up, a default network is created to include all containers in the `service` section. If changes are made to a service and the compose is updated, old network stops running and a new one is created with a different IP address.

      Instead of the default network, one can defined their own network using `networks` in YAML. Multiple `networks` can be defined in one compose YAML file. Different containers can connect to different networks using the `networks` key under their own services declaration.

  - volumes

      Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. It is managed by Docker instead of host machine. Once volumes are created for services in Docker Compose, it is reused every time `docker compose up` is run. Volume can be created outside of compose YAML file using `docker volmue create` and later referenced in the YAML file. Volumes are assigned to services using the service-level key `volumes` under each container declaration.

  - services

      Services are the containers used in this application. At least one service needs to be declared for the docker compose to run correctly. Service definition contains the configuration of each service containers. Containers used are specified seperately from each other. After defining the name of the container, base image for this container is specified using `images` and configurations are listed under `envrionment`. It is better to specify the version of images used in order to prevent the containers from being rebuilt due to new version being published. `volumes` and `networks` associated with the containers are also specified here using service-level `volumes` and `networks`. Docker compose YAML file is indentation sensitive so it is important to note the syntax.

      In addition to `volumes` and `networks`, omero-server and omero-web need to declare the ports used. `volumes` of omero-server can be set to a local folder to access files easily in the application. In order to set a local folder as OMERO_DATA_DIR, specify the folder under `volumes` key using `PATH_TO/FOLDER:/OMERO`. 

- Example Docker compose YAML file

  The content of the yaml file is shown below. The name of the file can only be `docker-compose.yml` so Docker can recognize it. The file can also be downloaded [here](docker_compose/docker-compose.yml).

  ```
  networks:
    omero-network:
  
  volumes:
    database:
    omero: # if local folder is not used
  
  services:
    database:
      image: "postgres:14"
      environment:
        POSTGRES_USER: omero
        POSTGRES_DB: omero
        POSTGRES_PASSWORD: omero
      networks:
        - omero-network
      volumes:
        - "database:/var/lib/postgresql/data"
  
    omeroserver:
      image: "openmicroscopy/omero-server:5"
      environment:
        CONFIG_omero_db_host: database
        CONFIG_omero_db_user: omero
        CONFIG_omero_db_pass: omero
        CONFIG_omero_db_name: omero
        ROOTPASS: omero-root
        CONFIG_omero_client_download__as_max__size: 5000000000 # value can be changed
      networks:
        - omero-network
      ports:
        - "4063:4063"
        - "4064:4064"
      volumes:
        - "PATH_TO/FOLDER:/OMERO" # use local folder as data directory
        #- "omero:/OMERO" # use volume 'omero' as data directory
      ulimits: # values can be changed
        nofile:
          soft: 8192
          hard: 65536
    
    omeroweb:
      image: "openmicroscopy/omero-web-standalone:5"
      environment:
        OMEROHOST: omeroserver
      networks:
        - omero-network
      ports:
        - "4080:4080"
  ```

-----

## Running Docker compose YAML file
  
   First, `cd` into the directory that contains `docker-compose.YAML`. There should only be one in each directory to avoid conflits. Pull the specified version of the containers using `docker compose pull`. Run the Compose using the command `docker-compose up`, with optional flags such as `-d` for detaching the process. To stop the application, run `docker-compose stop`.
   
To access the container, run `docker-compose exec omeroserver bash`. After getting to bash, one can use `/opt/omero/server/venv3/bin/omero` to run omero command such as `import`. Details on `import` can be found in [here](import_export_sop.md).

- Clean and restart Docker compose

  First stop the applications using `docker-compose down`, which will stop the application and remove the networks. Next, delete all containers and volumes using `docker rm -f $(docker ps -a -q)` (will throw error if no container is running) and `docker volume rm $(docker volume ls -q)`. Restart the application by running `docker-compose  up -d` to rebuild the containers.

  If one cannot connect to the server via the web client, run `docker compose logs -f` to inspect the containers. One might need to remove certain files from the data directory. For example, if import failed, one might need to remove user folders under `ManagedRepository`. If log in failed, one might need to remove locked files under `.omero -> repository`.


### Markdown Editor License


MIT

**Free Software, Hell Yeah!**
